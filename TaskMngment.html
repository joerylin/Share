<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä»»å‹™ç®¡ç†å°å·¥å…· v5.3 - å°ˆæ¥­å›æ­¸ç‰ˆ</title>
  <style>
    /* æ ¸å¿ƒæ¨£å¼å®Œå…¨åƒç…§ v4.0 */
    * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { margin: 0; padding: 20px; background-color: #f5f7fa; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
    h2 { color: #2c3e50; margin-top: 30px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

    /* é ‚éƒ¨å·¥å…·åˆ— */
    .toolbar { text-align: center; margin-bottom: 25px; }
    .toolbar button {
      background-color: #3498db; color: white; border: none; padding: 10px 16px;
      margin: 0 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .toolbar button:hover { opacity: 0.9; }
    .export-btn { background-color: #9b59b6; }
    .import-btn { background-color: #e67e22; }
    .settings-btn { background-color: #8e44ad; }
    .add-btn { background-color: #2ecc71; font-weight: bold; padding: 12px 20px; font-size: 16px; }

    /* è‰¾æ£®è±ªçŸ©é™£æ¨™é¡Œèˆ‡é¡è‰²æ¨£å¼ */
    .matrix { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .quadrant { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
    .quadrant h3 { margin-top: 0; text-align: center; color: white; padding: 10px; border-radius: 6px; font-size: 1.1em; }
    .q1 h3 { background-color: #e74c3c; }
    .q2 h3 { background-color: #3498db; }
    .q3 h3 { background-color: #f39c12; }
    .q4 h3 { background-color: #2ecc71; }
    .matrix-task { padding: 8px; margin: 6px 0; border-radius: 4px; font-size: 0.95em; background: #f8f9fa; transition: background-color 0.3s; border-left: 3px solid #ddd; }

    /* è¡¨æ ¼æ¨£å¼ */
    .task-table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); margin-bottom: 30px; overflow-x: auto; }
    .task-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .task-table th, .task-table td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .task-table th { background-color: #f1f3f5; font-weight: bold; color: #2c3e50; }
    
    .task-actions button { padding: 5px 10px; margin: 0 4px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; color: white; }
    .edit-btn { background-color: #3498db; }
    .delete-btn { background-color: #e74c3c; }
    .complete-btn { background-color: #27ae60; }
    .clear-btn { background-color: #e74c3c; font-size: 13px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; }

    /* æ¨¡æ…‹çª— */
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: white; margin: 5% auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }
    .modal label { display: block; margin-top: 15px; font-weight: bold; }
    .modal input, .modal select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; }
    .modal-actions { margin-top: 25px; text-align: right; }
    .modal-save { background-color: #2ecc71; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
    .modal-cancel { background-color: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š ä»»å‹™ç®¡ç†å°å·¥å…·ï¼ˆè‰¾æ£®è±ªçŸ©é™£ï¼‰</h1>

    <div class="toolbar">
      <button class="add-btn" onclick="openTaskModal()">â• æ–°å¢ä»»å‹™</button>
      <button class="export-btn" onclick="exportTasks()">ğŸ“¥ åŒ¯å‡ºè³‡æ–™</button>
      <button class="import-btn" onclick="document.getElementById('fileInput').click()">ğŸ“ åŒ¯å…¥è³‡æ–™</button>
      <button class="settings-btn" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
      <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importTasks(event)" />
    </div>

    <div class="matrix">
      <div class="quadrant q1"><h3>ğŸ”´ I. é‡è¦ & ç·Šæ€¥(Do)</h3><div id="q1-tasks"></div></div>
      <div class="quadrant q2"><h3>ğŸ”µ II. é‡è¦ & ä¸ç·Šæ€¥(Schedule)</h3><div id="q2-tasks"></div></div>
      <div class="quadrant q3"><h3>ğŸŸ  III. ä¸é‡è¦ & ç·Šæ€¥(Delegate)</h3><div id="q3-tasks"></div></div>
      <div class="quadrant q4"><h3>ğŸŸ¢ IV. ä¸é‡è¦ & ä¸ç·Šæ€¥(Delete)</h3><div id="q4-tasks"></div></div>
    </div>

    <div class="task-table-container">
      <h2 style="text-align:left">ğŸ“‹ é€²è¡Œä¸­ä»»å‹™ï¼ˆæ’åºï¼šè±¡é™ â†’ ç·Šæ€¥ â†’ é‡è¦ï¼‰</h2>
      <table class="task-table">
        <thead>
          <tr>
            <th>è±¡é™</th><th>ä»»å‹™åç¨±</th><th>é‡è¦æ€§</th><th>æˆªæ­¢æ—¥æœŸ</th><th>å‰©é¤˜å¤©æ•¸</th><th>å·¥ä½œå¤©æ•¸</th><th>é€²åº¦ (%)</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="activeTaskTableBody"></tbody>
      </table>
    </div>

    <div class="task-table-container">
      <h2 style="text-align:left">
        <span>âœ… å·²å®Œæˆé …ç›®åˆ—è¡¨</span>
        <button class="clear-btn" onclick="clearCompleted()">ğŸ§¹ æ¸…ç©ºå·²å®Œæˆé …ç›®</button>
      </h2>
      <table class="task-table">
        <thead>
          <tr><th>ä»»å‹™åç¨±</th><th>å®Œæˆæ—¥æœŸ</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="completedTaskTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">æ–°å¢ä»»å‹™</h2>
      <input type="hidden" id="editIndex" value="-1" />
      <label>ä»»å‹™åç¨±</label><input type="text" id="taskName" placeholder="ä¾‹å¦‚ï¼šå®Œæˆå ±å‘Š" />
      <label>é‡è¦æ€§ (1-5)</label>
      <select id="importance"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option></select>
      <label>æˆªæ­¢æ—¥æœŸ</label><input type="date" id="dueDate" />
      <label>å·¥ä½œå¤©æ•¸</label><input type="number" id="workDays" value="1" min="1" />
      <label>é€²åº¦ (%)</label><input type="number" id="progress" value="0" min="0" max="100" />
      <div class="modal-actions">
        <button class="modal-cancel" onclick="closeModal('taskModal')">å–æ¶ˆ</button>
        <button class="modal-save" onclick="saveTask()">å„²å­˜ä»»å‹™</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
      <label>ç·Šæ€¥å¤©æ•¸é–€æª»</label><input type="number" id="urgentThreshold" value="7" />
      <label><input type="checkbox" id="enableHighlight" checked /> å•Ÿç”¨ç·Šæ€¥åº•è‰²æé†’</label>
      <label>åº•è‰²æé†’é–€æª» (å¤©æ•¸)</label><input type="number" id="highlightThreshold" value="5" />
      <div class="modal-actions">
        <button class="modal-cancel" onclick="closeModal('settingsModal')">å–æ¶ˆ</button>
        <button class="modal-save" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
      </div>
    </div>
  </div>

<script>
  let tasks = [];
  let settings = { urgentThreshold: 7, enableHighlight: true, highlightThreshold: 5 };

  // åˆå§‹åŒ–è¼‰å…¥
  window.onload = () => {
    const saved = localStorage.getItem('taskManagerData');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        tasks = data.tasks || [];
        settings = data.settings || settings;
      } catch (e) { console.error("è¼‰å…¥å¤±æ•—", e); }
    }
    refresh();
  };

  // å„²å­˜è‡³æœ¬åœ° (Task 3: ä¸å„²å­˜è¡ç”Ÿæ¬„ä½)
  function saveData() {
    const cleanTasks = tasks.map(({ name, importance, dueDate, workDays, progress, completedAt }) => 
      ({ name, importance, dueDate, workDays, progress, completedAt }));
    localStorage.setItem('taskManagerData', JSON.stringify({ tasks: cleanTasks, settings }));
  }

  // æ ¸å¿ƒè¨ˆç®—èˆ‡åˆ·æ–° (Task 1: å‹•æ…‹è¨ˆç®—èˆ‡è®Šè‰²)
  function refresh() {
    const today = new Date(); today.setHours(0,0,0,0);

    tasks.forEach(t => {
      const due = new Date(t.dueDate); due.setHours(0,0,0,0);
      t.diffDays = Math.ceil((due - today) / 86400000);
      const isImportant = t.importance >= 4;
      const isUrgent = t.diffDays <= settings.urgentThreshold;
      t.quadrant = isImportant ? (isUrgent ? 1 : 2) : (isUrgent ? 3 : 4);
    });

    render();
    saveData();
  }

  // Task 1: æ ¹æ“š v4.0 é‚è¼¯è¨ˆç®—è®Šè‰²é€æ˜åº¦
  function getUrgentColor(quadrant, diffDays) {
    if (!settings.enableHighlight || diffDays > settings.highlightThreshold || diffDays < 0) return '';
    const maxDays = settings.highlightThreshold;
    const alpha = Math.max(0.05, 0.35 - (diffDays / maxDays) * 0.25);
    const colors = { 1: '231, 76, 60', 2: '52, 152, 219', 3: '243, 156, 18', 4: '46, 204, 113' };
    return `rgba(${colors[quadrant] || '243, 156, 18'}, ${alpha.toFixed(2)})`;
  }

  function render() {
    // é€²è¡Œä¸­æ’åºï¼šè±¡é™ -> å¤©æ•¸ -> é‡è¦æ€§
    const active = tasks.filter(t => t.progress < 100).sort((a,b) => a.quadrant - b.quadrant || a.diffDays - b.diffDays || b.importance - a.importance);
    const completed = tasks.filter(t => t.progress === 100);

    const activeBody = document.getElementById('activeTaskTableBody');
    const completedBody = document.getElementById('completedTaskTableBody');
    activeBody.innerHTML = ''; completedBody.innerHTML = '';
    [1,2,3,4].forEach(i => document.getElementById(`q${i}-tasks`).innerHTML = '');

    // æ¸²æŸ“é€²è¡Œä¸­
    active.forEach(t => {
      const realIdx = tasks.indexOf(t);
      const bgColor = getUrgentColor(t.quadrant, t.diffDays);
      
      // çŸ©é™£æ¸²æŸ“
      const div = document.createElement('div');
      div.className = 'matrix-task';
      div.textContent = `${t.name} (${t.diffDays >= 0 ? t.diffDays + 'å¤©' : 'é€¾æœŸ'}, ${t.progress}%)`;
      if(bgColor) div.style.backgroundColor = bgColor;
      document.getElementById(`q${t.quadrant}-tasks`).appendChild(div);

      // è¡¨æ ¼æ¸²æŸ“
      const row = document.createElement('tr');
      if(bgColor) row.style.backgroundColor = bgColor;
      row.innerHTML = `
        <td>Q${t.quadrant}</td><td>${t.name}</td><td>${t.importance}</td><td>${t.dueDate}</td>
        <td>${t.diffDays >= 0 ? t.diffDays + 'å¤©' : 'é€¾æœŸ'}</td><td>${t.workDays}</td><td>${t.progress}%</td>
        <td class="task-actions">
          <button class="complete-btn" onclick="markComplete(${realIdx})">âœ“ å®Œæˆ</button>
          <button class="edit-btn" onclick="editTask(${realIdx})">âœï¸ ç·¨è¼¯</button>
          <button class="delete-btn" onclick="deleteTask(${realIdx})">ğŸ—‘ï¸ åˆªé™¤</button>
        </td>`;
      activeBody.appendChild(row);
    });

    // æ¸²æŸ“å·²å®Œæˆ
    completed.forEach(t => {
      const realIdx = tasks.indexOf(t);
      const row = document.createElement('tr');
      row.innerHTML = `<td>${t.name}</td><td>${t.completedAt || '-'}</td>
        <td class="task-actions">
          <button class="edit-btn" onclick="editTask(${realIdx})">âœï¸ ç·¨è¼¯</button>
          <button class="delete-btn" onclick="deleteTask(${realIdx})">ğŸ—‘ï¸ åˆªé™¤</button>
        </td>`;
      completedBody.appendChild(row);
    });
  }

  // ç·¨è¼¯åŠŸèƒ½ (Task 2 & 3)
  function editTask(idx) {
    const t = tasks[idx];
    document.getElementById('editIndex').value = idx;
    document.getElementById('modalTitle').textContent = 'âœï¸ ç·¨è¼¯ä»»å‹™';
    document.getElementById('taskName').value = t.name;
    document.getElementById('importance').value = t.importance;
    document.getElementById('dueDate').value = t.dueDate;
    document.getElementById('workDays').value = t.workDays;
    document.getElementById('progress').value = t.progress;
    document.getElementById('taskModal').style.display = 'block';
  }

  function saveTask() {
    const name = document.getElementById('taskName').value;
    const date = document.getElementById('dueDate').value;
    if (!name || !date) return alert('è«‹å®Œæ•´å¡«å¯«åç¨±èˆ‡æ—¥æœŸ');
    
    const progress = parseInt(document.getElementById('progress').value);
    const taskObj = {
      name, 
      importance: parseInt(document.getElementById('importance').value),
      dueDate: date, 
      workDays: parseInt(document.getElementById('workDays').value),
      progress: progress,
      completedAt: progress === 100 ? (tasks[parseInt(document.getElementById('editIndex').value)]?.completedAt || new Date().toISOString().split('T')[0]) : null
    };

    const idx = parseInt(document.getElementById('editIndex').value);
    if (idx === -1) tasks.push(taskObj); else tasks[idx] = taskObj;
    
    closeModal('taskModal'); refresh();
  }

  function openTaskModal() {
    document.getElementById('editIndex').value = -1;
    document.getElementById('modalTitle').textContent = 'â• æ–°å¢ä»»å‹™';
    document.getElementById('taskName').value = '';
    document.getElementById('dueDate').valueAsDate = new Date(Date.now() + 604800000);
    document.getElementById('progress').value = 0;
    document.getElementById('taskModal').style.display = 'block';
  }

  function markComplete(idx) { 
    tasks[idx].progress = 100; 
    tasks[idx].completedAt = new Date().toISOString().split('T')[0]; 
    refresh(); 
  }

  function deleteTask(idx) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) { tasks.splice(idx, 1); refresh(); } }

  function clearCompleted() { if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²å®Œæˆçš„é …ç›®å—ï¼Ÿ')) { tasks = tasks.filter(t => t.progress < 100); refresh(); } }

  function openSettings() {
    document.getElementById('urgentThreshold').value = settings.urgentThreshold;
    document.getElementById('enableHighlight').checked = settings.enableHighlight;
    document.getElementById('highlightThreshold').value = settings.highlightThreshold;
    document.getElementById('settingsModal').style.display = 'block';
  }

  function saveSettings() {
    settings.urgentThreshold = parseInt(document.getElementById('urgentThreshold').value);
    settings.enableHighlight = document.getElementById('enableHighlight').checked;
    settings.highlightThreshold = parseInt(document.getElementById('highlightThreshold').value);
    closeModal('settingsModal'); refresh();
  }

  function closeModal(id) { document.getElementById(id).style.display = 'none'; }

  function exportTasks() {
    const blob = new Blob([JSON.stringify({tasks, settings}, null, 2)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'TaskList_Export.json'; a.click();
  }

  function importTasks(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        tasks = data.tasks || [];
        settings = data.settings || settings;
        refresh();
      } catch(err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
    };
    reader.readAsText(e.target.files[0]);
    e.target.value = '';
  }
</script>
</body>
</html>
