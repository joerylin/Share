<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä»»å‹™ç®¡ç†å°å·¥å…· - è‰¾æ£®è±ªçŸ©é™£</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1, h2 {
      color: #2c3e50;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 30px;
      margin-bottom: 15px;
    }

    /* é ‚éƒ¨å·¥å…·åˆ— */
    .toolbar {
      text-align: center;
      margin-bottom: 25px;
    }
    .toolbar button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 16px;
      margin: 0 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .toolbar button:hover {
      opacity: 0.9;
    }
    .export-btn { background-color: #9b59b6; }
    .import-btn { background-color: #e67e22; }
    .settings-btn { background-color: #8e44ad; }
    .add-btn {
      background-color: #2ecc71;
      font-weight: bold;
      padding: 12px 20px;
      font-size: 16px;
    }

    /* è‰¾æ£®è±ªçŸ©é™£ */
    .matrix {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .quadrant {
      background: white;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    .quadrant h3 {
      margin-top: 0;
      text-align: center;
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 1.1em;
    }
    .q1 h3 { background-color: #e74c3c; } /* é‡è¦ & ç·Šæ€¥ */
    .q2 h3 { background-color: #3498db; } /* é‡è¦ & ä¸ç·Šæ€¥ */
    .q3 h3 { background-color: #f39c12; } /* ä¸é‡è¦ & ç·Šæ€¥ */
    .q4 h3 { background-color: #2ecc71; } /* ä¸é‡è¦ & ä¸ç·Šæ€¥ */
    .matrix-task {
      padding: 8px;
      margin: 6px 0;
      border-radius: 4px;
      font-size: 0.95em;
      background: #f8f9fa;
      transition: background-color 0.3s;
    }

    /* è¡¨æ ¼é€šç”¨ */
    .task-table-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      overflow-x: auto;
    }
    .task-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .task-table th,
    .task-table td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .task-table th {
      background-color: #f1f3f5;
      font-weight: bold;
      color: #2c3e50;
    }
    .task-row {
      transition: background-color 0.3s;
    }
    .task-actions button {
      padding: 5px 10px;
      margin: 0 4px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .edit-btn { background-color: #3498db; color: white; }
    .delete-btn { background-color: #e74c3c; color: white; }
    .complete-btn { background-color: #27ae60; color: white; }

    /* æ¨¡æ…‹çª—é€šç”¨æ¨£å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 550px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #7f8c8d;
    }
    .modal label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #2c3e50;
    }
    .modal input, .modal select, .modal .progress-control {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }
    .progress-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .progress-btn {
      width: 30px;
      height: 36px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .progress-input {
      width: 70px !important;
      text-align: center;
    }
    .modal-actions {
      margin-top: 25px;
      text-align: right;
    }
    .modal-actions button {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .modal-save { background-color: #2ecc71; color: white; }
    .modal-cancel { background-color: #95a5a6; color: white; }
    .modal-save:hover { background-color: #27ae60; }
    .modal-cancel:hover { background-color: #7f8c8d; }

    /* è¨­å®šæ¨¡æ…‹çª— */
    .settings-option {
      margin-top: 15px;
    }
    .settings-option label {
      display: flex;
      align-items: center;
      font-weight: normal;
      color: #34495e;
    }
    .settings-option input[type="checkbox"] {
      margin-right: 10px;
    }
    #highlightSetting {
      margin-top: 15px;
      display: none;
    }

    /* éš±è—æª”æ¡ˆä¸Šå‚³ */
    #fileInput { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š ä»»å‹™ç®¡ç†å°å·¥å…·ï¼ˆè‰¾æ£®è±ªçŸ©é™£ï¼‰</h1>

    <!-- é ‚éƒ¨å·¥å…·åˆ— -->
    <div class="toolbar">
      <button class="add-btn" id="openModalBtn">â• æ–°å¢ä»»å‹™</button>
      <button class="export-btn" id="exportBtn">ğŸ“¥ åŒ¯å‡ºè³‡æ–™</button>
      <button class="import-btn" id="importBtn">ğŸ“ åŒ¯å…¥è³‡æ–™</button>
      <button class="settings-btn" id="settingsBtn">âš™ï¸ è¨­å®š</button>
      <input type="file" id="fileInput" accept=".json" />
    </div>

    <!-- è‰¾æ£®è±ªçŸ©é™£ï¼ˆæœ€ä¸Šæ–¹ï¼‰ -->
    <div class="matrix">
      <div class="quadrant q1">
        <h3>ğŸ”´ I. é‡è¦ & ç·Šæ€¥(Do)</h3>
        <div id="q1-tasks" class="task-list"></div>
      </div>
      <div class="quadrant q2">
        <h3>ğŸ”µ II. é‡è¦ & ä¸ç·Šæ€¥(Schedule)</h3>
        <div id="q2-tasks" class="task-list"></div>
      </div>
      <div class="quadrant q3">
        <h3>ğŸŸ  III. ä¸é‡è¦ & ç·Šæ€¥(Delegate)</h3>
        <div id="q3-tasks" class="task-list"></div>
      </div>
      <div class="quadrant q4">
        <h3>ğŸŸ¢ IV. ä¸é‡è¦ & ä¸ç·Šæ€¥(Delete)</h3>
        <div id="q4-tasks" class="task-list"></div>
      </div>
    </div>

    <!-- æ‰€æœ‰ä»»å‹™æ¸…å–®ï¼ˆæœªå®Œæˆï¼‰ -->
    <div class="task-table-container">
      <h2>ğŸ“‹ é€²è¡Œä¸­ä»»å‹™ï¼ˆæ’åºï¼šè±¡é™ â†’ ç·Šæ€¥ â†’ é‡è¦ï¼‰</h2>
      <table class="task-table" id="activeTaskTable">
        <thead>
          <tr>
            <th>è±¡é™</th>
            <th>ä»»å‹™åç¨±</th>
            <th>é‡è¦æ€§</th>
            <th>æˆªæ­¢æ—¥æœŸ</th>
            <th>å‰©é¤˜å¤©æ•¸</th>
            <th>å·¥ä½œå¤©æ•¸</th>
            <th>é€²åº¦ (%)</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="activeTaskTableBody"></tbody>
      </table>
    </div>

    <!-- å·²å®Œæˆä»»å‹™æ¸…å–® -->
    <div class="task-table-container">
      <h2>âœ… å·²å®Œæˆé …ç›®åˆ—è¡¨</h2>
      <table class="task-table" id="completedTaskTable">
        <thead>
          <tr>
            <th>ä»»å‹™åç¨±</th>
            <th>å®Œæˆæ—¥æœŸ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="completedTaskTableBody"></tbody>
      </table>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯ä»»å‹™æ¨¡æ…‹çª— -->
    <div id="taskModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" id="closeModal">&times;</span>
        <h2 id="modalTitle">æ–°å¢ä»»å‹™</h2>
        <input type="hidden" id="editIndex" value="-1" />
        <label>ä»»å‹™åç¨±</label>
        <input type="text" id="taskName" placeholder="ä¾‹å¦‚ï¼šå®Œæˆå°ˆæ¡ˆå ±å‘Š" />

        <label>é‡è¦æ€§ï¼ˆ1=æœ€ä½, 5=æœ€é«˜ï¼‰</label>
        <select id="importance">
          <option value="1">1 - ä¸é‡è¦</option>
          <option value="2">2</option>
          <option value="3">3 - ä¸­ç­‰</option>
          <option value="4">4</option>
          <option value="5" selected>5 - éå¸¸é‡è¦</option>
        </select>

        <label>æˆªæ­¢æ—¥æœŸ</label>
        <input type="date" id="dueDate" />

        <label>é ä¼°å·¥ä½œå¤©æ•¸</label>
        <input type="number" id="workDays" min="1" value="1" />

        <label>å®Œæˆé€²åº¦ (%)</label>
        <div class="progress-wrapper">
          <button class="progress-btn" id="decProgress">-</button>
          <input type="range" id="progressSlider" min="0" max="100" step="5" value="0" class="progress-control" />
          <button class="progress-btn" id="incProgress">+</button>
          <input type="number" id="progressInput" min="0" max="100" value="0" class="progress-input" />
        </div>

        <div class="modal-actions">
          <button class="modal-cancel" id="cancelModal">å–æ¶ˆ</button>
          <button class="modal-save" id="saveModal">å„²å­˜ä»»å‹™</button>
        </div>
      </div>
    </div>

    <!-- è¨­å®šæ¨¡æ…‹çª— -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" id="closeSettings">&times;</span>
        <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
        
        <label>ç·Šæ€¥å¤©æ•¸é–€æª»ï¼ˆå¤©æ•¸ï¼‰</label>
        <input type="number" id="urgentThreshold" min="1" class="threshold-input" placeholder="ç”¨æ–¼è‰¾æ£®è±ªçŸ©é™£åˆ†é¡" />

        <div class="settings-option">
          <label>
            <input type="checkbox" id="enableUrgentHighlight" />
            å•Ÿç”¨ç·Šæ€¥åº•è‰²æé†’ï¼ˆæ‰€æœ‰è±¡é™ï¼‰
          </label>
        </div>
        
        <div id="highlightSetting">
          <label>åº•è‰²æé†’å¤©æ•¸ï¼ˆå¤©æ•¸ï¼‰</label>
          <input type="number" id="highlightThreshold" min="1" class="threshold-input" placeholder="åƒ…åº•è‰²ä½¿ç”¨" />
        </div>

        <div class="modal-actions">
          <button class="modal-cancel" id="cancelSettings">å–æ¶ˆ</button>
          <button class="modal-save" id="saveSettings">å„²å­˜è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è¨­å®šï¼šåˆ†é›¢å…©å€‹é–€æª»
    let settings = JSON.parse(localStorage.getItem('taskMgrSettings')) || {
      urgentThreshold: 7,      // ç”¨æ–¼è‰¾æ£®è±ªçŸ©é™£åˆ†é¡ï¼ˆç·Šæ€¥/ä¸ç·Šæ€¥ï¼‰
      enableUrgentHighlight: true,
      highlightThreshold: 5    // åƒ…ç”¨æ–¼åº•è‰²æé†’
    };
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

    // DOM
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModal = document.getElementById('closeModal');
    const cancelModal = document.getElementById('cancelModal');
    const saveModal = document.getElementById('saveModal');
    const taskModal = document.getElementById('taskModal');
    const modalTitle = document.getElementById('modalTitle');
    const taskNameInput = document.getElementById('taskName');
    const importanceSelect = document.getElementById('importance');
    const dueDateInput = document.getElementById('dueDate');
    const workDaysInput = document.getElementById('workDays');
    const editIndexInput = document.getElementById('editIndex');
    const progressSlider = document.getElementById('progressSlider');
    const progressInput = document.getElementById('progressInput');
    const decProgress = document.getElementById('decProgress');
    const incProgress = document.getElementById('incProgress');

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const cancelSettings = document.getElementById('cancelSettings');
    const saveSettings = document.getElementById('saveSettings');
    const urgentThresholdInput = document.getElementById('urgentThreshold');
    const enableUrgentHighlightInput = document.getElementById('enableUrgentHighlight');
    const highlightThresholdInput = document.getElementById('highlightThreshold');
    const highlightSettingDiv = document.getElementById('highlightSetting');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const fileInput = document.getElementById('fileInput');

    // åˆå§‹åŒ–è¨­å®š UI
    function updateSettingsUI() {
      urgentThresholdInput.value = settings.urgentThreshold;
      enableUrgentHighlightInput.checked = settings.enableUrgentHighlight;
      highlightThresholdInput.value = settings.highlightThreshold;
      highlightSettingDiv.style.display = settings.enableUrgentHighlight ? 'block' : 'none';
    }
    updateSettingsUI();

    // äº‹ä»¶ç¶å®š
    openModalBtn.addEventListener('click', () => openTaskModal());
    closeModal.addEventListener('click', () => taskModal.style.display = 'none');
    cancelModal.addEventListener('click', () => taskModal.style.display = 'none');
    saveModal.addEventListener('click', saveTask);

    settingsBtn.addEventListener('click', () => {
      updateSettingsUI();
      settingsModal.style.display = 'block';
    });
    closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');
    cancelSettings.addEventListener('click', () => settingsModal.style.display = 'none');
    saveSettings.addEventListener('click', saveSettingsFunc);

    enableUrgentHighlightInput.addEventListener('change', () => {
      highlightSettingDiv.style.display = enableUrgentHighlightInput.checked ? 'block' : 'none';
      if (enableUrgentHighlightInput.checked) {
        highlightThresholdInput.value = settings.highlightThreshold;
      }
    });

    exportBtn.addEventListener('click', exportTasksAsJSON);
    importBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileImport);

    // é€²åº¦æ§åˆ¶
    progressSlider.addEventListener('input', () => {
      progressInput.value = progressSlider.value;
    });
    progressInput.addEventListener('input', () => {
      let val = parseInt(progressInput.value) || 0;
      val = Math.min(100, Math.max(0, val));
      progressInput.value = val;
      progressSlider.value = val;
    });
    decProgress.addEventListener('click', () => {
      let val = parseInt(progressSlider.value) - 5;
      if (val >= 0) {
        progressSlider.value = val;
        progressInput.value = val;
      }
    });
    incProgress.addEventListener('click', () => {
      let val = parseInt(progressSlider.value) + 5;
      if (val <= 100) {
        progressSlider.value = val;
        progressInput.value = val;
      }
    });

    // è¨­å®šä»Šå¤©æ—¥æœŸç‚ºé è¨­
    const today = new Date();
    dueDateInput.valueAsDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000); // é è¨­ +7 å¤©
    progressSlider.value = 0;
    progressInput.value = 0;

    // åˆå§‹æ¸²æŸ“
    renderAll();

    // --- åŠŸèƒ½å‡½å¼ ---
    function openTaskModal(editIndex = -1) {
      modalTitle.textContent = editIndex === -1 ? 'â• æ–°å¢ä»»å‹™' : 'âœï¸ ç·¨è¼¯ä»»å‹™';
      editIndexInput.value = editIndex;

      if (editIndex === -1) {
        taskNameInput.value = '';
        importanceSelect.value = '5';
        workDaysInput.value = '1';
        dueDateInput.valueAsDate = new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000);
        progressSlider.value = 0;
        progressInput.value = 0;
      } else {
        const t = tasks[editIndex];
        taskNameInput.value = t.name;
        importanceSelect.value = t.importance;
        dueDateInput.value = t.dueDate;
        workDaysInput.value = t.workDays;
        progressSlider.value = t.progress || 0;
        progressInput.value = t.progress || 0;
      }
      taskModal.style.display = 'block';
    }

    function saveTask() {
      const name = taskNameInput.value.trim();
      const importance = parseInt(importanceSelect.value);
      const dueDate = new Date(dueDateInput.value);
      const workDays = parseInt(workDaysInput.value) || 1;
      const progress = parseInt(progressInput.value) || 0;

      if (!name || isNaN(dueDate.getTime())) {
        alert('è«‹å¡«å¯«ä»»å‹™åç¨±èˆ‡æœ‰æ•ˆæˆªæ­¢æ—¥æœŸï¼');
        return;
      }

      const now = new Date();
      const diffTime = dueDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      // ğŸ”¥ é—œéµï¼šä½¿ç”¨ urgentThreshold ä¾†åˆ†é¡è‰¾æ£®è±ªçŸ©é™£
      const isImportant = importance >= 4;
      const isUrgent = diffDays <= settings.urgentThreshold;
      const quadrant = isImportant ? (isUrgent ? 1 : 2) : (isUrgent ? 3 : 4);

      const task = {
        name,
        importance,
        dueDate: dueDate.toISOString().split('T')[0],
        workDays,
        progress,
        diffDays,
        isUrgent,
        isImportant,
        quadrant,
        completedAt: progress === 100 ? new Date().toISOString().split('T')[0] : null
      };

      const editIndex = parseInt(editIndexInput.value);
      if (editIndex >= 0) {
        tasks[editIndex] = task;
      } else {
        tasks.push(task);
      }

      // åƒ…å°é€²è¡Œä¸­ä»»å‹™æ’åº
      const activeTasks = tasks.filter(t => t.progress < 100);
      const completedTasks = tasks.filter(t => t.progress === 100);

      activeTasks.sort((a, b) => {
        if (a.quadrant !== b.quadrant) return a.quadrant - b.quadrant;
        if (a.diffDays !== b.diffDays) return a.diffDays - b.diffDays;
        return b.importance - a.importance;
      });

      tasks = [...activeTasks, ...completedTasks];
      localStorage.setItem('tasks', JSON.stringify(tasks));
      taskModal.style.display = 'none';
      renderAll();
    }

    function saveSettingsFunc() {
      const newUrgent = parseInt(urgentThresholdInput.value) || 7;
      const newHighlightEnabled = enableUrgentHighlightInput.checked;
      const newHighlight = newHighlightEnabled ? (parseInt(highlightThresholdInput.value) || 5) : 5;

      settings = { 
        urgentThreshold: newUrgent, 
        enableUrgentHighlight: newHighlightEnabled, 
        highlightThreshold: newHighlight 
      };
      localStorage.setItem('taskMgrSettings', JSON.stringify(settings));
      settingsModal.style.display = 'none';
      renderAll();
    }

    function exportTasksAsJSON() {
      if (tasks.length === 0) {
        alert('æ²’æœ‰ä»»å‹™å¯åŒ¯å‡ºï¼');
        return;
      }
      const data = { settings, tasks };
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'TaskMgr.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function handleFileImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const data = JSON.parse(event.target.result);
          let importedTasks = [];
          let importedSettings = settings;

          if (Array.isArray(data)) {
            importedTasks = data;
          } else if (data && typeof data === 'object') {
            if (data.settings) importedSettings = data.settings;
            if (Array.isArray(data.tasks)) importedTasks = data.tasks;
          } else {
            throw new Error('ç„¡æ•ˆæ ¼å¼');
          }

          const validTasks = importedTasks.map(t => {
            if (!t.name || !t.dueDate || typeof t.importance !== 'number') {
              throw new Error('ä»»å‹™æ ¼å¼ä¸æ­£ç¢º');
            }
            const due = new Date(t.dueDate);
            if (isNaN(due.getTime())) throw new Error('ç„¡æ•ˆæ—¥æœŸ');

            const now = new Date();
            const diff = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
            const isImportant = t.importance >= 4;
            // ğŸ”¥ ä½¿ç”¨ importedSettings.urgentThreshold
            const isUrgent = diff <= importedSettings.urgentThreshold;
            const quadrant = isImportant ? (isUrgent ? 1 : 2) : (isUrgent ? 3 : 4);

            return {
              ...t,
              progress: t.progress || 0,
              completedAt: (t.progress === 100 && t.completedAt) ? t.completedAt : null,
              diffDays: diff,
              isUrgent,
              isImportant,
              quadrant
            };
          });

          tasks = validTasks;
          settings = importedSettings;
          localStorage.setItem('tasks', JSON.stringify(tasks));
          localStorage.setItem('taskMgrSettings', JSON.stringify(settings));
          updateSettingsUI();
          renderAll();
          alert('âœ… åŒ¯å…¥æˆåŠŸï¼å·²è¼‰å…¥ ' + tasks.length + ' å€‹ä»»å‹™ã€‚');
        } catch (err) {
          console.error(err);
          alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + (err.message || 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤'));
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function editTask(index) {
      openTaskModal(index);
    }

    function deleteTask(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ')) {
        tasks.splice(index, 1);
        localStorage.setItem('tasks', JSON.stringify(tasks));
        renderAll();
      }
    }

    function markAsCompleted(index) {
      if (tasks[index].progress === 100) return;
      if (confirm('ç¢ºå®šè¦æ¨™è¨˜æ­¤ä»»å‹™ç‚ºå·²å®Œæˆå—ï¼Ÿ')) {
        tasks[index].progress = 100;
        tasks[index].completedAt = new Date().toISOString().split('T')[0];
        localStorage.setItem('tasks', JSON.stringify(tasks));
        renderAll();
      }
    }

    // ğŸ”¥ ä½¿ç”¨ highlightThreshold ä¾†æ±ºå®šåº•è‰²
    function getUrgentColor(quadrant, diffDays) {
      if (!settings.enableUrgentHighlight || diffDays > settings.highlightThreshold || diffDays < 0) {
        return '';
      }

      const maxDays = settings.highlightThreshold;
      const alpha = Math.max(0.05, 0.3 - (diffDays / maxDays) * 0.25);
      
      const colors = {
        1: '231, 76, 60',   // ç´…
        2: '52, 152, 219',  // è—
        3: '243, 156, 18',  // æ©™
        4: '46, 204, 113'   // ç¶ 
      };
      const color = colors[quadrant] || '243, 156, 18';
      return `rgba(${color}, ${alpha.toFixed(2)})`;
    }

    function renderAll() {
      // æ¸…ç©º
      document.getElementById('q1-tasks').innerHTML = '';
      document.getElementById('q2-tasks').innerHTML = '';
      document.getElementById('q3-tasks').innerHTML = '';
      document.getElementById('q4-tasks').innerHTML = '';
      document.getElementById('activeTaskTableBody').innerHTML = '';
      document.getElementById('completedTaskTableBody').innerHTML = '';

      const activeTasks = [];
      const completedTasks = [];

      tasks.forEach((task, index) => {
        if (task.progress === 100) {
          completedTasks.push({ task, index });
        } else {
          activeTasks.push({ task, index });
        }
      });

      // æ¸²æŸ“è‰¾æ£®è±ªçŸ©é™£ï¼ˆåƒ… activeï¼‰
      activeTasks.forEach(({ task }) => {
        const daysInfo = task.diffDays >= 0 ? `${task.diffDays}å¤©` : 'å·²é€¾æœŸ';
        const taskText = `${task.name} (${daysInfo}, ${task.progress}%)`;

        const matrixEl = document.createElement('div');
        matrixEl.className = 'matrix-task';
        matrixEl.textContent = taskText;
        const bgColor = getUrgentColor(task.quadrant, task.diffDays);
        if (bgColor) matrixEl.style.backgroundColor = bgColor;

        if (task.quadrant === 1) {
          document.getElementById('q1-tasks').appendChild(matrixEl);
        } else if (task.quadrant === 2) {
          document.getElementById('q2-tasks').appendChild(matrixEl);
        } else if (task.quadrant === 3) {
          document.getElementById('q3-tasks').appendChild(matrixEl);
        } else {
          document.getElementById('q4-tasks').appendChild(matrixEl);
        }
      });

      // æ¸²æŸ“é€²è¡Œä¸­è¡¨æ ¼
      activeTasks.forEach(({ task, index }) => {
        const daysInfo = task.diffDays >= 0 ? `${task.diffDays}å¤©` : 'å·²é€¾æœŸ';
        const row = document.createElement('tr');
        row.className = 'task-row';
        const bgColor = getUrgentColor(task.quadrant, task.diffDays);
        if (bgColor) row.style.backgroundColor = bgColor;

        row.innerHTML = `
          <td>Q${task.quadrant}</td>
          <td>${task.name}</td>
          <td>${task.importance}</td>
          <td>${task.dueDate}</td>
          <td>${daysInfo}</td>
          <td>${task.workDays}</td>
          <td>${task.progress}%</td>
          <td class="task-actions">
            <button class="complete-btn" onclick="markAsCompleted(${index})">âœ“ å®Œæˆ</button>
            <button class="edit-btn" onclick="editTask(${index})">âœï¸ ç·¨è¼¯</button>
            <button class="delete-btn" onclick="deleteTask(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
          </td>
        `;
        document.getElementById('activeTaskTableBody').appendChild(row);
      });

      // æ¸²æŸ“å·²å®Œæˆè¡¨æ ¼
      completedTasks.forEach(({ task, index }) => {
        const row = document.createElement('tr');
        row.className = 'task-row';
        row.innerHTML = `
          <td>${task.name}</td>
          <td>${task.completedAt || 'æœªè¨˜éŒ„'}</td>
          <td class="task-actions">
            <button class="edit-btn" onclick="editTask(${index})">âœï¸ ç·¨è¼¯</button>
            <button class="delete-btn" onclick="deleteTask(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
          </td>
        `;
        document.getElementById('completedTaskTableBody').appendChild(row);
      });
    }

    // å…¨åŸŸå‡½å¼
    window.editTask = editTask;
    window.deleteTask = deleteTask;
    window.markAsCompleted = markAsCompleted;
  </script>
</body>
</html>